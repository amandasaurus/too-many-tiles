<!doctype html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
	<script defer>
		async function calc(bbox, canvas_el) {
			var ctx = canvas_el.getContext("2d");
			let z = bbox.z;
			for (var x=bbox.xmin; x<=bbox.xmax; x++) {
				for (var y=bbox.ymin; y<=bbox.ymax; y++) {
					var img = new Image();
					var src = `//tile.openstreetmap.org/${z}/${x}/${y}.png`;
					img.crossOrigin = "Anonymous";
					img.src = src;
				    await new Promise(r => img.onload=r, img.src=src);
					ctx.drawImage(img, (x-bbox.xmin)*256, (y-bbox.ymin)*256);
				}
			}
			var image_url = canvas_el.toDataURL("image/png");
			var dlLink = document.createElement("a");
			dlLink.download = `tiles-${z}-${bbox.xmin}-${bbox.xmax}-${bbox.ymin}-${bbox.ymax}.png`;
			dlLink.href = image_url
			dlLink.dataset.downloadurl = ["image/png", dlLink.download, dlLink.href].join(':');
			document.getElementById("download_link").appendChild(dlLink);
			console.log(dlLink);
			dlLink.click();
		}
	</script>
</head>
<body>
	<main x-data="{
	  bbox: {
		  xmin: 0,
		  xmax: 1,
		  ymin: 0,
		  ymax: 1,
		  z: 1,
		  get width() { 
		  	if (this.xmax <= this.xmin) {
				return 0;
			} else {
			  return (this.xmax - this.xmin + 1)*256;
			}
		  },
		  get height() { 
		  	if (this.ymax <= this.ymin) {
				return 0;
			} else {
			  return (this.ymax - this.ymin + 1)*256;
			}
		  }
	  }

	 }">
		<div>
			Zoom: <input type=number x-model="bbox.z" min=0 max=18 width=2>
			X: <input type=number x-model="bbox.xmin"> - <input type=number x-model="bbox.xmax">
			Y: <input type=number x-model="bbox.ymin"> - <input type=number x-model="bbox.ymax">
		</div>
		<div>
			Image is <span x-text="bbox.width"></span>Ã—<span x-text="bbox.height"></span> pixels big. 
		</div>

		<div>
			<button @click="calc(bbox, document.getElementById('final_image'));">Generate</button>
			<span id=download_link></span>
		</div>
		<canvas id=final_image :width="bbox.width" :height="bbox.height">
		</canvas>

	</main>
</body>
</html>
